<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Mari's Notes" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="Mari&#39;s Notes">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Mari&#39;s Notes">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mari&#39;s Notes">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Mari's Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mari's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/10/Globbing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/10/Globbing/" itemprop="url">Globbing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-10T20:52:19+08:00">
                2018-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Globbing-Matching-Files"><a href="#Globbing-Matching-Files" class="headerlink" title="Globbing: Matching Files"></a>Globbing: Matching Files</h2><p>Any time you want to operate on a bunch of file that have similar names, you an use glob pattern to do it.</p>
<p>I am not making up ths name. Globbing is the real,actual,technical term for matching files by name in the Unix shell. Seriously, globbing. If you don’t believe me you can look it up, <code>man glob</code>.</p>
<p>Globbing is kind of pattern matching for file names. When you write a glob pattern in a shell command,the shell turns. that pattern into a list of file names that exist to match the pattern.</p>
<p>For instance,a star matches any string of characters. You an use a star at the beginning or at the end of a pattern.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls *html</span><br><span class="line"><span class="meta">$</span> ls app*</span><br></pre></td></tr></table></figure></p>
<p>Patterns can be all sorts of different lengths. You an use two stars in the same pattern. For instance,here,matching every file whose name contains pp.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls *pp*</span><br></pre></td></tr></table></figure></p>
<p>A star can appear in the middle of a pattern. Matching all the files that start with B and end with png.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls b*png</span><br></pre></td></tr></table></figure></p>
<p>There are other patterns you an use as well.<br>Foe instance,to match files thar end in either CSS or HTML,a list of strings in curly braces will match any of the alternatives.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls app.&#123;css.html&#125;</span><br></pre></td></tr></table></figure></p>
<p>A single queston mark matches any one character. So BEA question mark dot png matches both bean and bear,but it doesn’t match beer or bess.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls bea?.png</span><br></pre></td></tr></table></figure></p>
<p>Two question marks matches two characters,and so on.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls bc??.png</span><br></pre></td></tr></table></figure></p>
<p>List of characters inside square brackets matches an one of the characters inside those brackets,so be and then square brackets A-E-I-O-U R dot png will match bear and beer, but not bean or bes.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls be[aeiou]r.png</span><br></pre></td></tr></table></figure></p>
<p>Something to watch out for is that file name in Linux are always case sensitive, and that applies to globbing too.<br>For instace,if you have files that end in jpg in capitals and files that end in jpg in lower case,you have to specify which one you want.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls *JPG</span><br><span class="line"><span class="meta">$</span> ls *jpg</span><br></pre></td></tr></table></figure></p>
<p>If you want both,you could use the curly braces.<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls *&#123;JPG,jpg&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Quiz"><a href="#Quiz" class="headerlink" title="Quiz"></a>Quiz</h2><ol>
<li><p>Copy all the files in the “www” directory that end in “html” to the “backup” directory.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp www/*html backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>List all the files that end in “jpg” or “png” in the current directory.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls *&#123;jpg,png&#125;</span><br><span class="line"><span class="meta">$</span> ls *jpg *png</span><br><span class="line"><span class="meta">$</span> ls *&#123;jp,pn&#125;g</span><br></pre></td></tr></table></figure>
</li>
<li><p>Print “Short names:” followed by all the one-character filenames int current directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo Short names: ?</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/01/Digging-支付宝首页交互三部曲2自定义Behavior/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/01/Digging-支付宝首页交互三部曲2自定义Behavior/" itemprop="url">[Digging]支付宝首页交互三部曲2自定义Behavior</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-01T20:52:13+08:00">
                2017-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://otiwf3ulm.bkt.clouddn.com/7fa7fd062bad4bd7d01c3d8bcd65672d.png" alt="digging2"></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>自己动手实现支付宝首页效果 , 用三篇文章记录并分享给大家。</p>
<ul>
<li>CoordinatorLayout和Behavior</li>
<li>自定义CoordiantorLayout和Behavior</li>
<li>支付宝首页效果实现</li>
</ul>
<blockquote>
<p>文中 : Col 表示 CoordinatorLayout , ABL 表示AppBarLayout , CTL 表示 CollapsingToolbarLayout , SRL 表示 SwipeRefreshLaout , RV 表示 RecyclerVIew。</p>
</blockquote>
<p>第二篇文章主要用经典的CoordinatorLayout、AppBarLayout、RecyclerView的联动场景（CAR场景）来分析一下自定义Behavior需要关注的内容 , 以及如何自定义一个Behavior。同时 , 支付宝首页效果和AppBarLayout的效果有相似之处 , 分析CAR场景 , 也有意于后文实现支付宝首页效果。</p>
<blockquote>
<p>这篇文章适合同时阅读源码 , 如果已经读过源码 , 可以直接诶跳到最后总结。</p>
</blockquote>
<h3 id="Support中的Behavior基类"><a href="#Support中的Behavior基类" class="headerlink" title="Support中的Behavior基类"></a>Support中的Behavior基类</h3><p>CAR场景中一共出现了两个Behavior , AppBarLayout.Behavior和AppBarLayout.ScrollingViewBehavior , 前者应用于ABL , 后者应用于RV。这两个Behavior是我们这篇文章要分析的主要的类 , 但是在开始之前 , 我们要看一下它们的基类（职责分隔的很不错）。</p>
<h4 id="ViewOffsetBehavior"><a href="#ViewOffsetBehavior" class="headerlink" title="ViewOffsetBehavior"></a>ViewOffsetBehavior</h4><p>使用ViewOffsetHelper工具类封装View的偏移量。View类支持对offset进行偏移 , 但是并不会保存偏移量。ViewOffsetHelper对Offset和Top/left进行缓存 , 使用ViewCompat工具类进行偏移处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private void updateOffsets() &#123;</span><br><span class="line">  ViewCompat.offsetTopAndBottom(mView, mOffsetTop - (mView.getTop() - mLayoutTop));</span><br><span class="line">  ViewCompat.offsetLeftAndRight(mView, mOffsetLeft - (mView.getLeft() - mLayoutLeft));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewOffsetBehavior除了封装了对水平和垂直方向偏移的Setter和Getter方法 , 还覆写了<code>onLaoutChild()</code>方法 , 上一篇文章中有提到 , 实现这个方法可以代理CoL对子View的布局。不过ViewOffsetBehavior覆写这个方法的目的主要是创建ViewOffsetHelper , 获取真实偏移量并且将child偏移到正确位置。</p>
<blockquote>
<p>说句题话外 , 当我们考虑一个滑动交互时 , 不要把滑动看做一个连续的过程 , 而是要拆分成多个单独的循环过程 , 连续的滑动只不过是单独循环过程在时间上不断重复而已 ； 而滑动的单个循环过程 , 说到底是对View进行偏移处理。当看到一个复杂交互效果的时候 , 要学会拆分 , 一个是刚说的时间上拆分 , 另一个方面就是要能拆分成多个单独效果的合成 , 能做到这一步 , 再加上牢固的基础 , 就没有什么交互效果是做不出来的。</p>
</blockquote>
<h4 id="HeaderBehavior"><a href="#HeaderBehavior" class="headerlink" title="HeaderBehavior"></a>HeaderBehavior</h4><p>HeaderBehavior封装了经典Touch事件分发逻辑 , 主要是实现了Behavior的<code>onInterceptTouchEvent</code>方法和<code>onTouchEvent</code>方法　, 逻辑其实也很简单 :</p>
<ul>
<li>判断是否可以滑动</li>
<li>当滑动超过阀值之后 , 标记滑动（mIsBeingDragged）并进行拦截</li>
<li>处理ACTION_MOVE事件　, 调用ViewOffsetBehavior的方法进行偏移</li>
<li>使用VelocityTracker计算滑动速度</li>
<li>在ACTION_UP分之中停止并判断是否应该Fling</li>
<li><p>实现scroll和fling方法</p>
<p>HeaderBehavior的实现简单且清晰 , 都可以当作经典Touch事件实现活动的范例了 , 有这方面需求的同学不要错过。因为HeaderBehavior的定位很明确 , 实现类似AppBarLayout类似的Header功能 , 所以只处理了纵向滑动。</p>
</li>
</ul>
<p>除了scroll和fling暴露给子类的方法主要是<code>setHeaderTopBoottimOffset</code> , 这个方法一共有两个重载声明 , 可以设置边界值避免滑动越界。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">int setHeaderTopBottomOffset(CoordinatorLayout parent, V header, int newOffset) &#123;</span><br><span class="line">    return setHeaderTopBottomOffset(parent, header, newOffset,</span><br><span class="line">            Integer.MIN_VALUE, Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int setHeaderTopBottomOffset(CoordinatorLayout parent, V header, int newOffset,</span><br><span class="line">        int minOffset, int maxOffset) &#123;</span><br><span class="line">    final int curOffset = getTopAndBottomOffset();</span><br><span class="line">    int consumed = 0;</span><br><span class="line"></span><br><span class="line">    if (minOffset != 0 &amp;&amp; curOffset &gt;= minOffset &amp;&amp; curOffset &lt;= maxOffset) &#123;</span><br><span class="line">        // If we have some scrolling range, and we&apos;re currently within the min and max</span><br><span class="line">        // offsets, calculate a new offset</span><br><span class="line">        newOffset = MathUtils.constrain(newOffset, minOffset, maxOffset);</span><br><span class="line"></span><br><span class="line">        if (curOffset != newOffset) &#123;</span><br><span class="line">            setTopAndBottomOffset(newOffset);</span><br><span class="line">            // Update how much dy we have consumed</span><br><span class="line">            consumed = curOffset - newOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return consumed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个方法是有返回值的 , 这个返回值在子类中处理嵌套滑动或者再次分发滑动是非常有用。</p>
</blockquote>
<h4 id="HeaderScrollingViewBehavior"><a href="#HeaderScrollingViewBehavior" class="headerlink" title="HeaderScrollingViewBehavior"></a>HeaderScrollingViewBehavior</h4><p>同样继承自ViewOffsetBehavior , HeaderScrollingViewBehavior的职责主要是完成对ScrollingView的布局。 CoL的职责是给子类提供协调滚动的接口 , 并不会具体实现某种效果 , 所有子类需要完成的功能和效果 , 都需要通过统一接口Behavior完成。</p>
<p>在Header+ScrollingView的结构中 , HeaderScrollingViewBehavior就是对ScrollingView的控制。 <strong>这两者结合要实现的就是MaterialDesign中经典的可收起Header的效果。</strong></p>
<p>为了让Header可收起 , 视觉上ScrollingView的高度被拉长了 , 但实际上ScrollingView的高度并没有变 , 变的是ScrollingView的位置。ScrollingView的测量和布局就是HeaderScrollingViewBehavior的实现内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">final int childLpHeight = child.getLayoutParams().height;</span><br><span class="line">if (childLpHeight == ViewGroup.Layout.MATCH_PARENT || childLpHeight == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">  // If the menu&apos;s height is set match_parent/wrap_content then measure it</span><br><span class="line">  // with the maximum visible height</span><br><span class="line"></span><br><span class="line">      // &#123;...&#125;</span><br><span class="line">      return true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">return false;</span><br></pre></td></tr></table></figure>
<p><code>onMeasureChild</code>方法中的注释说明了只要child和LayoutParams是MATCH_PARENT或者WRAP_CONTENT , 就设置child的高度为<strong>最大可见高度。</strong> 这里的最大可见高度包含除了header之外的区域以及header收起时额外空出的区域 , 也就是<strong>header的可滚动区域。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">int availableHeight = View.MeasureSpec.getSize(parentHeightMeasureSpec);</span><br><span class="line">if (availableHeight == 0) &#123;</span><br><span class="line">    // If the measure spec doesn&apos;t specify a size, use the current height</span><br><span class="line">    availableHeight = parent.getHeight();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final int height = availableHeight - header.getMeasuredHeight()</span><br><span class="line">        + getScrollRange(header);</span><br></pre></td></tr></table></figure>
<p><code>onLayout</code> 中将ScrollingView置于header下方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">available.set(</span><br><span class="line">  parent.getPaddingLeft() + lp.leftMargin,</span><br><span class="line">  header.getBottom() + lp.topMargin,</span><br><span class="line">  parent.getWidth() - parent.getPaddingRight() - lp.rightMargin,</span><br><span class="line">  parent.getHeight() + header.getBottom() - parent.getPaddingBottom() - lp.bottomMargin</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>注意这里Rect的top值取<code>header.getBottom() + lp.topMargin</code> , 而不是 <code>getPaddingTop() + header.getHeight + lp.topMargin</code> , 这是因为header在onLayout时可能已经包含偏移量 , 不能<strong>假定</strong>header在初始位置 , 即便可能90%的情况均是如此。</p>
<p>说句题外话 , 项目开发过程中会遇到很多这类情况 , 有多种实现方式都能达到预期效果 , 但并不是所有的实现方案都是完整符合<strong>预期逻辑</strong>的。比如上面的例子 , ScrollingView的预期位置是header下方 , 而不是父控件中除header高度以外的区域。有的时候 , 需要转换角度看问题 , 体会下这其中的区别。</p>
<h4 id="AppBarLayout-Behavior"><a href="#AppBarLayout-Behavior" class="headerlink" title="AppBarLayout.Behavior"></a>AppBarLayout.Behavior</h4><p>AppBarLayout.ScrollingViewBehavior相对简单 , 这里略过。 AppbarLayout.Behavior继承自HeaderBehavior , 在其基础上 , 主要实现了以下功能：</p>
<ol>
<li><p>支持在布局文件中定义滚动效果：SCROLL/ECIT_UNTIL_COLLAPSED/ENTER_ALWAYLS/ENTER_ALWAYLS_COLLAPSED/SMAP</p>
</li>
<li><p>实现NestedScrolling回调</p>
</li>
</ol>
<p>滚动效果不是这篇文章的重点 , 我们主要看下NestedScrolling的相关实现。</p>
<p><strong>onStartNestedScroll</strong></p>
<p>判断是否是否为纵向滑动 , 并且AppBarLayout支持折叠并且ScrollingView的大小超出屏幕范围。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Return true if we&apos;re nested scrolling vertically, and we have scrollable children</span><br><span class="line">// and the scrolling view is big enough to scroll</span><br><span class="line">final boolean started = (nestedScrollAxes &amp; ViewCompat.SCROLL_AXIS_VERTICAL) != 0</span><br><span class="line">        &amp;&amp; child.hasScrollableChildren()</span><br><span class="line">        &amp;&amp; parent.getHeight() - directTargetChild.getHeight() &lt;= child.getHeight();</span><br></pre></td></tr></table></figure>
<p><strong>onNestedPreScroll</strong></p>
<p>这个方法回提前于 ScrollingView 消费滑动事件。AppBarLayout 的 scrollFlags , 也就是上面说的滚动效果会影响 onNestedPreScroll 方法的实现。抛开这个影响 , 这个方法中 , 首先确定 AppBarLayout 的可滑动范围 , 然后调用 <code>scroll()</code> 方法（继承自ViewOffsetBehavior）进行滚动 , 并将消费多少传递给 <code>consumed</code> 数组。</p>
<p><strong>onNestedScroll</strong></p>
<p>如果向下滚动时 , 在ScrollingVIew消费完滑动时间之后 , 还有剩余 , 说明 ScrollingView 已经滚动到顶部 , AppBarLayout 开始展开。</p>
<p><strong>onNestedFling</strong></p>
<p>这里并没有进行精确的消费 , 只是当ScrollingView触发flag时 , 对 AppbarLayout 执行动画 , 展开或者收起。<strong>下篇文章实现支付宝首页效果时 , 实现了对 fling 的精确消费。</strong></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>自定义Behavior主要关心一下两个方面：</p>
<ol>
<li><p>测量和布局</p>
</li>
<li><p>实现滑动效果</p>
</li>
</ol>
<p>其中滑动效果有三种实现方式：</p>
<ol>
<li><p>经典Touch事件</p>
</li>
<li><p>NestedScrolling</p>
</li>
<li><p>LayoutDependent</p>
</li>
</ol>
<p>一般情况下 , CoL的child , 如果自身不可滚动 , 需要实现NestedScrolling来进行联动 , 或者实现Touch事件回调。如果自身可以滚动 , 通过 <code>onDependentViewChanged</code> 方法来响应其他View的偏移量改变事件。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/30/Digging-支付宝首页交互三部曲1CoordinatorLayout和Behavior/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/30/Digging-支付宝首页交互三部曲1CoordinatorLayout和Behavior/" itemprop="url">[Digging]支付宝首页交互三部曲1CoordinatorLayout和Behavior</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-30T21:34:01+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://otiwf3ulm.bkt.clouddn.com/2272923f2d28ef82c3680eea371e8eff.png" alt="zhifubao_first"></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>自己动手实现支付宝首页效果 , 用三篇文章记录并分享给大家。</p>
<ul>
<li>CoordinatorLayout和Behavior</li>
<li>自定义CoordiantorLayout和Behavior</li>
<li>支付宝首页效果实现</li>
</ul>
<blockquote>
<p>文中 : Col 表示 CoordiantorLayout , ABL 表示AppBarLayout , CTL 表示 CollapsingToolbarLayout , SRL 表示 SwipeRefreshLaout , RV 表示 RecyclerVIew。</p>
</blockquote>
<p>第一篇文章主要讨论Behavior的结构、CoordianatorLayout的实现以及Coordianator和Behavoir之间的通信。除了Behavior相关的内容 , CoordinarotLayout作为官方实现的一个ViewGroup , 也有一些自定义ViewGroup时可以借鉴的内容 , 这些也穿插在这篇文章中。</p>
<h3 id="Behavior结构"><a href="#Behavior结构" class="headerlink" title="Behavior结构"></a>Behavior结构</h3><p>使用 CoordinatorLayout 结合 ABL , CTL , SWL/RV 可以方便的实现各种 MaterialDesign ToolBar 效果 , 还有 FloatingActionButton , SnackBar 等控件 , 可以直接使用。 Col的主要功能是为其子View提供 <strong>协调滚动</strong> 的统一接口 , 让子View可以方便的实现诸如嵌套滚动 , 跟随滚动等效果 , 让界面更加灵动 ; 而这个统一接口 , 就是Behavior。</p>
<p>我们先来看一下 Behavior 提供的方法 , 大致可以分为4组:</p>
<p><strong>布局相关</strong> , 这类方法用来重载child的Mesure、 Layout相关的回调。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public boolean onMeasureChild(CoordinatorLayout parent, V child,</span><br><span class="line">                int parentWidthMeasureSpec, int widthUsed,</span><br><span class="line">                int parentHeightMeasureSpec, int heightUsed);</span><br><span class="line">public boolean onLayoutChild(CoordinatorLayout parent, V child, int layoutDirection);</span><br><span class="line">public boolean layoutDependsOn(CoordinatorLayout parent, V child, View dependency);</span><br><span class="line">public boolean onDependentViewChanged(CoordinatorLayout parent, V child, View dependency);</span><br><span class="line">public void onDependentViewRemoved(CoordinatorLayout parent, V child, View dependency)</span><br></pre></td></tr></table></figure>
<p><strong>Touch事件相关</strong> , 这组方法用来拦截和处理Touch事件传递。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean onInterceptTouchEvent(CoordinatorLayout parent, V child, MotionEvent ev);</span><br><span class="line">public boolean onTouchEvent(CoordinatorLayout parent, V child, MotionEvent ev);</span><br><span class="line">public boolean blocksInteractionBelow(CoordinatorLayout parent, V child);</span><br></pre></td></tr></table></figure>
<p><strong>NestedScrolling相关</strong> , 这组方法用来响应NestedScrolling , 更多的NestedScrolling的讨论可以查看<a href="https://marishunxiang.github.io/2017/08/27/Android-Nested-Scrolling/" target="_blank" rel="noopener">另一篇博客</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public boolean onStartNestedScroll(CoordinatorLayout coordinatorLayout,</span><br><span class="line">                V child, View directTargetChild, View target, int nestedScrollAxes);</span><br><span class="line">public void onNestedScrollAccepted(CoordinatorLayout coordinatorLayout, V child,</span><br><span class="line">                                View directTargetChild, View target, int nestedScrollAxes);</span><br><span class="line">public void onStopNestedScroll(CoordinatorLayout coordinatorLayout, V child, View target);</span><br><span class="line">public void onNestedScroll(CoordinatorLayout coordinatorLayout, V child, View target,</span><br><span class="line">                int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed);</span><br><span class="line">public void onNestedPreScroll(CoordinatorLayout coordinatorLayout, V child, View target,</span><br><span class="line">                              int dx, int dy, int[] consumed);                      </span><br><span class="line">public boolean onNestedFling(CoordinatorLayout coordinatorLayout, V child, View target,</span><br><span class="line">                          float velocityX, float velocityY, boolean consumed);      </span><br><span class="line">public boolean onNestedPreFling(CoordinatorLayout coordinatorLayout, V child, View target,</span><br><span class="line">                                          float velocityX, float velocityY)</span><br></pre></td></tr></table></figure>
<p><strong>其他辅助方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 关联/取消关联LayoutParams的时候回调</span><br><span class="line">public void onAttachedToLayoutParams(@NonNull CoordinatorLayout.LayoutParams params);</span><br><span class="line">public void onDetachedFromLayoutParams();</span><br><span class="line">// 控制Scrim效果 , 只有当getScrimOpaticy返回值不为0时才绘制。</span><br><span class="line">public int getScrimColor(CoordinatorLayout parent, V child);</span><br><span class="line">public float getScrimOpacity(CoordinatorLayout parent, V child);</span><br><span class="line">// 暂时没有发现用到的地方</span><br><span class="line">public static void setTag(View child, Object tag);</span><br><span class="line">public static Object getTag(View child);</span><br><span class="line">public boolean onRequestChildRectangleOnScreen(CoordinatorLayout coordinatorLayout,</span><br><span class="line">                V child, Rect rectangle, boolean immediate);</span><br><span class="line">public void onRestoreInstanceState(CoordinatorLayout parent, V child, Parcelable state);</span><br><span class="line">public Parcelable onSaveInstanceState(CoordinatorLayout parent, V child);</span><br><span class="line">// 防止Col子View间出现遮挡 , 获取child应避免遮挡部分的Rect。</span><br><span class="line">public boolean getInsetDodgeRect(@NonNull CoordinatorLayout parent, @NonNull V child,</span><br><span class="line">                @NonNull Rect rect);</span><br></pre></td></tr></table></figure>
<p>多数情况下我们只需要关注前三组方法。通过这些方法我们看到Behavior可以做的事情不仅仅是 “依赖某个View的变化并且在其变化后进行相应” 这么单一 , <strong>Behavior实际上可以控制child在Col中的mesure , layout以及拦截touch事件 , 支持NestedScrolling等等</strong> , 基本上是除了Draw之外的全部自定义VIew需要关注的内容了。</p>
<p>Behavior的使用和自定义我们下一篇文章进行讨论 , 这篇文章我们继续关注Col如何操作Behavior。</p>
<h3 id="设置Behavior"><a href="#设置Behavior" class="headerlink" title="设置Behavior"></a>设置Behavior</h3><p>给View设置Behavior有两种方法 : 在布局文件中指定 ; 使用<a href="mailto:`@CoordinatorLayout.DefaultBehavior" target="_blank" rel="noopener">`@CoordinatorLayout.DefaultBehavior</a>`注解。</p>
<p>第一种方法适用于多种情况 , 需要注意的是 ,　如果使用自定义Behavior , 需要覆写２个参数的构造方法 ;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Behavior(Context context, AttributeSet attrs);</span><br></pre></td></tr></table></figure>
<p>因为Col在解析时是通过反射调用Behavior的这个构造方法创建Behavior对象的 :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">static Behavior parseBehavior(Context context, AttributeSet attrs, String name) &#123;</span><br><span class="line">        if (TextUtils.isEmpty(name)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final String fullName;</span><br><span class="line">        if (name.startsWith(&quot;.&quot;)) &#123;</span><br><span class="line">            // Relative to the app package. Prepend the app package name.</span><br><span class="line">            fullName = context.getPackageName() + name;</span><br><span class="line">        &#125; else if (name.indexOf(&apos;.&apos;) &gt;= 0) &#123;</span><br><span class="line">            // Fully qualified package name.</span><br><span class="line">            fullName = name;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Assume stock behavior in this package (if we have one)</span><br><span class="line">            fullName = !TextUtils.isEmpty(WIDGET_PACKAGE_NAME)</span><br><span class="line">                    ? (WIDGET_PACKAGE_NAME + &apos;.&apos; + name)</span><br><span class="line">                    : name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Constructor&lt;Behavior&gt;&gt; constructors = sConstructors.get();</span><br><span class="line">            if (constructors == null) &#123;</span><br><span class="line">                constructors = new HashMap&lt;&gt;();</span><br><span class="line">                sConstructors.set(constructors);</span><br><span class="line">            &#125;</span><br><span class="line">            Constructor&lt;Behavior&gt; c = constructors.get(fullName);</span><br><span class="line">            if (c == null) &#123;</span><br><span class="line">                final Class&lt;Behavior&gt; clazz = (Class&lt;Behavior&gt;) Class.forName(fullName, true,</span><br><span class="line">                        context.getClassLoader());</span><br><span class="line">                c = clazz.getConstructor(CONSTRUCTOR_PARAMS);</span><br><span class="line">                c.setAccessible(true);</span><br><span class="line">                constructors.put(fullName, c);</span><br><span class="line">            &#125;</span><br><span class="line">            return c.newInstance(context, attrs);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Could not inflate Behavior subclass &quot; + fullName, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>第二种方法 , 适用于自定义View并且自定义Behavior的情况 , 比如AppBarLayout :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@CoordinatorLayout.DefaultBehavior(AppBarLayout.Behavior.class)</span><br><span class="line">public class AppBarLayout extends LinearLayout &#123;</span><br><span class="line">  // &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在布局文件中不另外指定 , 这里将调用Behavior的无参构造方法创建对象。</p>
<h3 id="事件分发"><a href="#事件分发" class="headerlink" title="事件分发"></a>事件分发</h3><p>上面看到的Behavior的各个方法 , 其调用者基本都是CoL。CoL在自己的回调方法中通过子View Behavior的相关方法 , 将事件向下分发。</p>
<p>在讨论分发方法之前 , 有一点需要注意 : <strong>Behavior随人影响的是子View的布局和行为 , 但实际是对CoL本身事件处理的代理。</strong></p>
<p>基本的模式大家可以想到 , 就是遍历子View , 获取Bahavior , 然后调用子Bahavior对应的方法。这里对几个有意思的地方进行讨论 :</p>
<h4 id="Touch事件分发"><a href="#Touch事件分发" class="headerlink" title="Touch事件分发"></a>Touch事件分发</h4><p>Touch事件分发分两个方法onInterceptTouchEvent和onTouchEvent。 CoL的视线中 , 这两个方法都调用<code>performIntercept</code>方法将是否拦截事件的判断交给Behavior处理。每个CoordinatorLayout的子View都有机会拦截事件并响应 , 注意这里子View并不是在自己的onTouch相关方法中进行处理, 而是Behavior子类 , 有机会代理CoL对事件进行拦截并处理。</p>
<p>处于篇幅考虑这里不贴源码了 , 关键的地方这里解释一下 :</p>
<ul>
<li><p>在遍历子View之前 , 使用<code>getTopSortedChildren(topmostChildList);</code>获取按照显示顺序自上至下排效果的子View列表。 ViewGroup可以复写<code>getChildDrawingOrder</code>自定义子View的绘制顺序 , getTopSortedChildren方法会按照绘制顺序获取子View ; 在5.0以上版本中 , 还要考虑Z轴次序 , 也就是elevation , 会再进行一次排序 , 最终得到真实可靠的自顶之下的子View分发顺序。这对让子View合理响应Touch事件很重要 , 如果自定义ViewGroup需要有类似功能 , 可以参考CoL的实现。</p>
</li>
<li><p>Behavior通过覆写<code>onInterceptTouch</code>或者<code>onTouchEvent</code>并返回true来声明拦截事件 , Col会将该View缓存到mBehaviorTouchView属性 , 后续事件将直接分发到该View。直到该View的onTouchEvent方法返回false。</p>
</li>
<li><p>在确定mBehaviorTouchView之后 , CoL会将该View（Z轴）下面View的事件流终止 , 具体操作是向这些View分发一个CANCEL事件。</p>
</li>
</ul>
<blockquote>
<p>Behavior可以通过覆写blocksInteractionBelow方法block下方View的事件。 在自己不需要处理事件但同时不希望子View处理事件时 , 可以简单的覆写这个方法。</p>
</blockquote>
<blockquote>
<p>默认实现逻辑是判断getScrimOpaticy的值&gt;0</p>
</blockquote>
<h4 id="NestedScrolling"><a href="#NestedScrolling" class="headerlink" title="NestedScrolling"></a>NestedScrolling</h4><p>NestedScrolling是Behavior实现滑动的重要支撑。前文提到Behavior是对CoL自身事件的代理 , 所以Behavior对NestedScrolling的支持 , 就是在代理CoL的NestedScrollingParent接口的方法。</p>
<blockquote>
<p>更多NestedScrolling相关信息参见更早的博客 : <a href="https://marishunxiang.github.io/2017/08/27/Android-Nested-Scrolling/" target="_blank" rel="noopener">Android Nested Scrolling</a></p>
</blockquote>
<p>需要注意的是关于NestedScrolling机制中”消费量”的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onNestedPreScroll(View target, int dx, int dy, int[] consumed) &#123;</span><br><span class="line">    int xConsumed = 0;</span><br><span class="line">    int yConsumed = 0;</span><br><span class="line">    boolean accepted = false;</span><br><span class="line"></span><br><span class="line">    final int childCount = getChildCount();</span><br><span class="line">    for (int i = 0; i &lt; childCount; i++) &#123;</span><br><span class="line">        final View view = getChildAt(i);</span><br><span class="line">        if (view.getVisibility() == GONE) &#123;</span><br><span class="line">            // If the child is GONE, skip...</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final LayoutParams lp = (LayoutParams) view.getLayoutParams();</span><br><span class="line">        if (!lp.isNestedScrollAccepted()) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final Behavior viewBehavior = lp.getBehavior();</span><br><span class="line">        if (viewBehavior != null) &#123;</span><br><span class="line">            mTempIntPair[0] = mTempIntPair[1] = 0;</span><br><span class="line">            viewBehavior.onNestedPreScroll(this, view, target, dx, dy, mTempIntPair);</span><br><span class="line"></span><br><span class="line">            xConsumed = dx &gt; 0 ? Math.max(xConsumed, mTempIntPair[0])</span><br><span class="line">                    : Math.min(xConsumed, mTempIntPair[0]);</span><br><span class="line">            yConsumed = dy &gt; 0 ? Math.max(yConsumed, mTempIntPair[1])</span><br><span class="line">                    : Math.min(yConsumed, mTempIntPair[1]);</span><br><span class="line"></span><br><span class="line">            accepted = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    consumed[0] = xConsumed;</span><br><span class="line">    consumed[1] = yConsumed;</span><br><span class="line"></span><br><span class="line">    if (accepted) &#123;</span><br><span class="line">        onChildViewsChanged(EVENT_NESTED_SCROLL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里是取了所有Behavior消费掉偏移量的最大值。因为Behavior是代理的角色 , 而各个代理的消费对于NestedScrolling机制来说 , 都会被看作是CoL这个NestedScrollingParent的消费。各Behavior之间是同级的 , 所以他们对事件的消费是”重叠”的（可以重复消费） , 所以这里返回的consumed是取最大值。</p>
<h4 id="LayoutDependence"><a href="#LayoutDependence" class="headerlink" title="LayoutDependence"></a>LayoutDependence</h4><p>这里是其他博客讲的比较多的地方 , 确定View依赖的dependency变化之后 , 会将变化广播给所有依赖这个View的兄弟View。这里我要说的有两点 : 1.onDependentViewChanged回调的时机。2.依赖关系的存贮。</p>
<ol>
<li>onDependentViewChanged在某个View的大小或者位置发生变化的时候都会进行回调。并且真正变化之后才会回调。</li>
<li>子View之间的依赖关系通过非循环有向图数据结构进行存储。具体到数据结构上就是通过一个<code>Map&lt;Node, List&lt;Node&gt;&gt;</code>存储（这个Map并不是JDK的实现 , 感兴趣的可以看下源码）。</li>
<li>既然存在依赖关系 , 那么在涉及到对子View遍历的时候 , 就要考虑到子View之间的依赖关系。CoL的实现中<code>prepareChildren</code>方法构建依赖图并根据依赖图进行DFS搜索得到依赖链列表 , 这个列表用在了分发布局、 NestedScrolling、 LayoutDependentChanged的过程中。</li>
</ol>
<h3 id="自定义LayoutParams"><a href="#自定义LayoutParams" class="headerlink" title="自定义LayoutParams"></a>自定义LayoutParams</h3><p>自定义ViewGroup很常见 , 但是多数情况下用不到自定义LayoutParams。LayoutParams正如其名 , 用了设置布局参数 , 也就是控制ViewGroup如何 mesure 和 layout 子View。 如果一个自定义ViewGroup提供了额外的布局参数 , 那就需要自定义LayoutParams了。自定义LayoutParams并没有多复杂 , 这里列出几点需要注意的地方。</p>
<h4 id="基类"><a href="#基类" class="headerlink" title="基类"></a>基类</h4><p>如果自定义LayoutParams需要支持margin , 继承自 <code>ViewGroup.MarginLayoutParams</code>即可 , 默认的ViewGroup.LayoutParams并不支持margin。</p>
<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><p>LayoutParams默认有多个不同参数的构造方法 :</p>
<ul>
<li>LayoutParams(Context context, AttrbuteSet attr) 使用于解析布局文件时生成LayoutParams , layout相关的xml属性 , 就是在这个构造方法里面解析的</li>
<li>LayoutParams(int width, int height) 代码构建时只传入宽高</li>
<li>LayoutParams(LayoutParams source) LayoutParams转换</li>
<li>LayoutParams() 无参构造函数</li>
</ul>
<p>自定义LayoutParams也要覆写这些构造方法并做相应的转换。</p>
<h4 id="ViewGroup方法"><a href="#ViewGroup方法" class="headerlink" title="ViewGroup方法"></a>ViewGroup方法</h4><p>使用自定义 LayoutParams 的 ViewGroup , 也需要实现几个相关方法 , 主要是在解析 、 addView 的时候生成适合的 LayoutParams。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected LayoutParams generateDefaultLayoutParams();</span><br><span class="line">protected LayoutParams generateLayoutParams(ViewGroup.LayoutParams p);</span><br><span class="line">public LayoutParams generateLayoutParams(AttributeSet attrs);</span><br><span class="line">// 检查LayoutParams是否自定义的LayoutParams类型</span><br><span class="line">protected boolean checkLayoutParams(ViewGroup.LayoutParams p);</span><br></pre></td></tr></table></figure>
<p>具体可以参考 CoL。</p>
<h4 id="CoordinatorLayout-LayoutParams"><a href="#CoordinatorLayout-LayoutParams" class="headerlink" title="CoordinatorLayout.LayoutParams"></a>CoordinatorLayout.LayoutParams</h4><p>CoL.LP 主要实现了基于 anchorView 的布局和 keylines（纵向基准线 , 子View可以对齐到keylines）的布局、 保存Bahavior、 存储滑动过程中的标记位 , 具体实现这里就不展开了 , 逻辑比较简单。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/27/Android-Nested-Scrolling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/27/Android-Nested-Scrolling/" itemprop="url">Android Nested Scrolling</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-27T19:34:18+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://otiwf3ulm.bkt.clouddn.com/1301a18845a986101aa7bbbbca4ff8c0.png" alt="NestedScrollHead"></p>
<p>Android常规的Touch事件机制是自顶向下 , 由外向内的, 一旦确定了时间消费者View , 随后的时间都将传递到该View。 因为是自顶向下 , 父控件可以随时拦截事件 , 下拉刷新、拖拽排序、折叠等交互效果都可以通过这套机制完成。Touch事件传递机制是Android开发必须掌握的基本内容。但是这套机制存在一个缺陷: <strong>子View 无法通知父View处理事件</strong> NestedScrolling就是为了这个场景设计的。</p>
<h3 id="NestedScrollingChild和NestedScrollingParent"><a href="#NestedScrollingChild和NestedScrollingParent" class="headerlink" title="NestedScrollingChild和NestedScrollingParent"></a>NestedScrollingChild和NestedScrollingParent</h3><p>NestedScrolling是指存在嵌套滑动的场景 , 常见用于下拉刷新、展开/收起标题栏等。Support包中的<code>CoordinatorLayout</code>和<code>ScrollRefreshLayout</code>就是基于NestedScrolling机制实现的。</p>
<p><code>NestedScrollingChild</code>和<code>NestedScrollParent</code>分别定义了嵌套子View和嵌套父View需要实现的接口,方法列表分别如下 , 可以先略过 , 后面会把这些方法串起来。另外这些方法基本都是通过<code>NestedScrollChildHelper</code>和<code>NestedScrollParentHelper</code>来实现的 , 一般并不需要手动编写多少逻辑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingChild</span><br><span class="line">void setNestedScrollingEnabled(boolean enabled);</span><br><span class="line">boolean isNestedScrollingEnabled();</span><br><span class="line">boolean startNestedScroll(int axes);</span><br><span class="line">void stopNestedScroll();</span><br><span class="line">boolean hasNestedScrollingParent();</span><br><span class="line">boolean dispatchNestedScroll(int dxConsumed, int dyConsumed,</span><br><span class="line">            int dxUnconsumed, int dyUnconsumed, int[] offsetInWindow);</span><br><span class="line">boolean dispatchNestedPreScroll(int dx, int dy, int[] consumed, int[] offsetInWindow);</span><br><span class="line">boolean dispatchNestedFling(float velocityX, float velocityY, boolean consumed);</span><br><span class="line">boolean dispatchNestedPreFling(float velocityX, float velocityY);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingParent</span><br><span class="line">boolean onStartNestedScroll(View child, View target, int nestedScrollAxes);</span><br><span class="line">void onNestedScrollAccepted(View child, View target, int nestedScrollAxes);</span><br><span class="line">void onStopNestedScroll(View target);</span><br><span class="line">void onNestedScroll(View target, int dxConsumed, int dyConsumed,</span><br><span class="line">            int dxUnconsumed, int dyUnconsumed);</span><br><span class="line">void onNestedPreScroll(View target, int dx, int dy, int[] consumed);</span><br><span class="line">boolean onNestedFling(View target, float velocityX, float velocityY, boolean consumed);</span><br><span class="line">boolean onNestedPreFling(View target, float velocityX, float velocityY);</span><br><span class="line">int getNestedScrollAxes();</span><br></pre></td></tr></table></figure>
<p>通过方法名可以看出,<code>NestedScrollingChild</code>的方法均为主动方法 , 而<code>NestedScrollingParent</code>的方法基本都是回调方法。这也是<code>NestedScrolling</code>机制的一个体现 , 子View作为NestedScrolling事件传递的主动方。</p>
<p>NestedScrolling机制生效的前提条件是子View作为Touch事件的消费者 , 在消费过程中向父View发送NestedScrolling事件（<strong>注意这里不是Touch事件 , 而是NestedScrolling事件</strong>）。</p>
<h3 id="NestedScrolling事件传递"><a href="#NestedScrolling事件传递" class="headerlink" title="NestedScrolling事件传递"></a>NestedScrolling事件传递</h3><p>NestedScrolling机制中 , NestedScrolling事件使用<code>dx,dy</code>表示 , 分别表示子View Touch 事件处理方法中判定的x和y方向上的滚动偏移量。</p>
<p>NestedScrolling事件的传递：</p>
<ol>
<li>由子View产生NestedScrolling事件 ;</li>
<li>发送给父View进行处理 , 父View处理之后 , 返回消费的偏移量 ;</li>
<li>子View根据View消费的偏移量计算NestedScrolling事件剩余偏移量 ;</li>
<li>根据剩余偏移量判断是否能处理滚动事件 ; 如果处理事件 , 同时将自身滚动情况通知父View ;</li>
<li>处理完成 , 事件传递完成。</li>
</ol>
<blockquote>
<ol>
<li>这里只说明了一层嵌套的情况 , 事实上NestedScrolling很可能出现在多重嵌套的场景。对于多重嵌套 , 步骤 2、3、4将事件自底向上进行传递 , 步骤2中消费的偏移量将记录所有嵌套父View消费偏移量的总和。这里不再重复。</li>
<li>Fling事件的传递和Scroll类似 , 也不再赘述。</li>
</ol>
</blockquote>
<h3 id="方法调用流程"><a href="#方法调用流程" class="headerlink" title="方法调用流程"></a>方法调用流程</h3><p>我们可以上面的方法根据NestedScrolling事件传递的不同阶段进行分组（Fling跟随Scrolling发生）。</p>
<p><strong>初始阶段：</strong> 确认开启NestedScrolling , 关联父View和子View。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingChild</span><br><span class="line">void setNestedScrollingEnabled(boolean enabled);</span><br><span class="line">boolean startNestedScroll(int axes);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingParent</span><br><span class="line">int getNestedScrollAxes();</span><br><span class="line">boolean onStartNestedScroll(View child, View target, int nestedScrollAxes);</span><br><span class="line">void onNestedScrollAccepted(View child, View target, int nestedScrollAxes);</span><br></pre></td></tr></table></figure>
<p><strong>预滚动阶段：</strong> 子View将事件分发到父View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingChild</span><br><span class="line">boolean dispatchNestedPreScroll(int dx, int dy, int[] consumed, int[] offsetInWindow);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingParent</span><br><span class="line">void onNestedPreScroll(View target, int dx, int dy, int[] consumed);</span><br></pre></td></tr></table></figure>
<p><strong>滚动阶段：</strong> 子View处理滚动事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingChild</span><br><span class="line">boolean dispatchNestedScroll(int dxConsumed, int dyConsumed,</span><br><span class="line">            int dxUnconsumed, int dyUnconsumed, int[] offsetInWindow);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingParent</span><br><span class="line">void onNestedScroll(View target, int dxConsumed, int dyConsumed,</span><br><span class="line">            int dxUnconsumed, int dyUnconsumed);</span><br></pre></td></tr></table></figure>
<p><strong>结束阶段：</strong> 结束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingChild</span><br><span class="line">void stopNestedScroll();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// NestedScrollingParent</span><br><span class="line">void onStopNestedScroll(View target);</span><br></pre></td></tr></table></figure>
<p>下面是一次嵌套滚动（三级嵌套）从开始到结束的方法调用时序图：</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/38b0dbd0d45c8dc0ba9c09b17df82467.png" alt="NestedScrollingThree"></p>
<blockquote>
<p>金色是<code>NestedScrollingChild</code>的方法 , 为View主动调用。</p>
</blockquote>
<blockquote>
<p>紫色是<code>NestedScrollingParent</code>回调的方法 , 由View的相关方法调用。</p>
</blockquote>
<blockquote>
<p>橙色是<strong>滚动事件被消费的时机</strong></p>
</blockquote>
<h3 id="划重点"><a href="#划重点" class="headerlink" title="划重点"></a>划重点</h3><p>最重要的一点：<strong>pre-scroll过程是子View向父View传递事件 , 而scroll过程才是子View消耗滚动事件的过程</strong> , 也就是说父View拥有优先消费事件的权利。</p>
<p>从事件消耗的优先级来看 , 可以画这样一张图。</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/89ad50e20fd57910556a37b5cfbcb689.png" alt="NestedScrollEvent"></p>
<p>dispatchNestedPreScroll传给父View的是没有被消费的滚动事件 , 父View消费完之后通过consumed数组返回 , 如果还有剩余 , 由子View进行消费 , 并将消费多少和剩余多少再次发给父View。</p>
<p>如果一个View同时作为NestedScrollChild和NestedScrollParent , 那么在处理 onNestedPreScrolling和onNestedScrolling的时候也要按照自底向上的规则 , 先让父View处理事件。</p>
<h3 id="实例分析以及Q-amp-A"><a href="#实例分析以及Q-amp-A" class="headerlink" title="实例分析以及Q&amp;A"></a>实例分析以及Q&amp;A</h3><p>这里通过对<strong>CoordinatorLayout -&gt; SwipeRefreshLaout -&gt; RecyclerView</strong>这个常用的三级嵌套实例进行分析 , 以便深入理解NestedScrolling事件传递的机制。</p>
<p>嗯 , 其实上面那张时序图基本就通过方法调用顺序 , 理清了传递过程。</p>
<p>这里通过几个Q&amp;A , 来答疑解惑。</p>
<blockquote>
<p>如果你还不清楚SwipeRefreshLaout的原理 , 建议先去看一下我的另外一篇文章：SwipeRefreshLaout源码解析<br>CL代表CoordinatorLayout , SRL 代表SwipeRefreshLaout , RV 表示RecyclerView</p>
</blockquote>
<p><strong>Q1：SwipeRefreshLaout在Touch事件分发过程中 , 为什么SwipeRefreshLaout没有作为Touch事件的消费者?</strong></p>
<p><strong>A1：</strong>Touch事件流从<strong>ACTION_DOWN</strong>开始：</p>
<ol>
<li>先经过SRL的<code>onInterceptTouchEvent()</code> , 返回false</li>
<li>进入RV的<code>onInterceptTouchEvent()</code> , 进入ACTION_DOWN分支 , RV调用<code>startNestedScroll()</code>方法</li>
<li>根据上面的时序图 , 会调用SRL的<code>onNestedScrollAccepted()</code> , 而这个方法里面 , 会将SRL的<code>mNestedScrollInProgress</code>设置为true。实际上到此为止已经进入了NestedScrolling事件的分发流程。</li>
<li>后续事件 , SRL的<code>onInterceptTouchEvent()</code>反复会根据<code>mNestedScrollInProgress</code>属性返回false , 也就不会拦截事件了。</li>
<li>CL的部分根据时序图可以清楚理解。</li>
</ol>
<p><strong>Q2：</strong>接Q1 , 既然没有拦截 , 为什么还能处理事件？</p>
<p><strong>A2：</strong>首先 , 要注意SRL主力的不是Touch事件 , 而是NestedScrolling事件 , 还记得吗 , 实际上是以(dx,dy)偏移量的形式存在的。A1中可以看到 , 一旦触发NestedScrolling机制 , 作为父View的SRL , 就有优先处理NestedScrolling事件的权利 , 所以当然能处理事件（当然优先级比CL低 , 所以只能处理CL处理剩下的部分）。</p>
<p><strong>Q3：</strong>为什么CL能消费事件进行滚动?</p>
<p><strong>A3：</strong>NestedScrolling机制决定NestedScrolling事件是自底向上传播的 , 并且通过pre-scroll和scoll两个过程划分 , 越上层的View , 处理NestedScrolling事件的优先级越高 , CL在最上层 , 自然优先处理事件。</p>
<p><strong>Q4：</strong>对于SwipeRefreshLaout来说 , 什么时候通过TouchEvent处理事件 , 什么时候通过NestedScrolling机制处理事件?</p>
<p><strong>A4：</strong>NestedScrolling机制由实现了NestedScrollingChild接口的子View触发 , 所以事实上 , 当SRL的子View实现了NestedScrollingChild接口时 , 均会使用NestedScrolling机制分发事件给SRL。比如RecyclerView作为子View将通过NestedScrolling处理事件 , 如果是ListView作为子View , 将通过Touch机制处理事件。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>读到这里你会发现 , 要理解NestedScrolling , 实际上就是要理解NestedScrolling事件分发过程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/轻量级自定义圆角ImageView-适配-Android-L/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/轻量级自定义圆角ImageView-适配-Android-L/" itemprop="url">轻量级自定义圆角ImageView-适配-Android-L</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-25T22:46:42+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在看Google的一个开源项目 Topeka ,想研究一下,了解大神都怎么写代码的.<br>官方介绍只有一句话：一部有趣的问答应用！<br><a href="https://github.com/googlesamples/android-topeka" target="_blank" rel="noopener">传送门</a></p>
<p>在app的登录页面有一个头像选择,实现了圆形头像,选择头像时ImageView外圈增加一个圆圈,而且适配了5.0以上的版本.实现也很优雅.于是我就仿照写了一个圆角的 ImageView.</p>
<p>效果如下：屏幕中间的就是自定义的 圆角ImageView</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/c739a9fae63484169161c2cf6d5fd795.png" alt="RoundImageView"></p>
<p>布局文件如下:</p>
<p>使用方法也很简单,在布局文件中使用就可以了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    &gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;com.sync.customviewstudy.view.RoundImageView</span><br><span class="line">      android:layout_width=&quot;80dp&quot;</span><br><span class="line">      android:layout_height=&quot;80dp&quot;</span><br><span class="line">      android:layout_centerInParent=&quot;true&quot;</span><br><span class="line">      android:id=&quot;@+id/img&quot;</span><br><span class="line">      android:src=&quot;@mipmap/avatar_12_raster&quot;</span><br><span class="line">      /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>先上自定义ImageVIew的代码:</p>
<p>AvatarView.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Description: 圆形头像</span><br><span class="line"> * Author：Mari on 2017-07-25 22:30</span><br><span class="line"> * Contact：289168296@qq.com</span><br><span class="line"> */</span><br><span class="line">public class RoundImageView extends ImageView &#123;</span><br><span class="line"></span><br><span class="line">  public RoundImageView(Context context) &#123;</span><br><span class="line">    super(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public RoundImageView(Context context, @Nullable AttributeSet attrs) &#123;</span><br><span class="line">    super(context, attrs);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public RoundImageView(Context context, @Nullable AttributeSet attrs, int defStyleAttr) &#123;</span><br><span class="line">    super(context, attrs, defStyleAttr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override public void setImageDrawable(@Nullable Drawable drawable) &#123;</span><br><span class="line">    if (ApiLevelHelper.isAtLeast(Build.VERSION_CODES.LOLLIPOP)) &#123;</span><br><span class="line">      setClipToOutline(true);</span><br><span class="line">      super.setImageDrawable(drawable);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      BitmapDrawable bitmapDrawable = (BitmapDrawable) drawable;</span><br><span class="line">      RoundedBitmapDrawable roundedDrawable =</span><br><span class="line">          RoundedBitmapDrawableFactory.create(getResources(), bitmapDrawable.getBitmap());</span><br><span class="line">      roundedDrawable.setCircular(true);</span><br><span class="line">      super.setImageDrawable(roundedDrawable);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // onLayout() 之后调用</span><br><span class="line">  @Override protected void onSizeChanged(int w, int h, int oldw, int oldh) &#123;</span><br><span class="line">    super.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line">    if (ApiLevelHelper.isLowerThan(Build.VERSION_CODES.LOLLIPOP)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (w &gt; 0 &amp;&amp; h &gt; 0) &#123;</span><br><span class="line">      setOutlineProvider(new RoundOutlineProvider(Math.min(w, h)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码很少,在 <code>setImageDrawable</code>,<code>onSizeChanged</code> 两个方法中区分 Android 5.0 即以上版本和5.0一下2个版本不同的处理方式, 5.0 以下版本使用 <code>RoundedBitmapDrawable</code> 实现圆形 <code>drawable</code> 资源,<br>而在 5.0 以上版本使用 <code>RoundOutlineProvider</code> 实现圆角 <code>drawable</code> 资源. ‘RoundOutlineProvider’ 继承 <code>ViewOutlineProvider</code> 这个类是在 <code>android.view.ViewOutlineProvider</code> 包下面,大家想要了解更多可以自己去找下资料看看哈.</p>
<p>RoundOutlineProvider.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Description: Creates round outlines for views.</span><br><span class="line"> * Author：Mari on 2017-07-25 22:30</span><br><span class="line"> * Contact：289168296@qq.com</span><br><span class="line"> */</span><br><span class="line">@RequiresApi(api = Build.VERSION_CODES.LOLLIPOP) public class RoundOutlineProvider extends ViewOutlineProvider &#123;</span><br><span class="line"></span><br><span class="line">  private final int mSize;</span><br><span class="line"></span><br><span class="line">  public RoundOutlineProvider(int size) &#123;</span><br><span class="line">    mSize = size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override public void getOutline(View view, Outline outline) &#123;</span><br><span class="line">    outline.setOval(0, 0, mSize, mSize);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApiLevelHelper.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Encapsulates checking api levels.</span><br><span class="line"> */</span><br><span class="line">public class ApiLevelHelper &#123;</span><br><span class="line"></span><br><span class="line">    private ApiLevelHelper() &#123;</span><br><span class="line">        //no instance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Checks if the current api level is at least the provided value.</span><br><span class="line">     *</span><br><span class="line">     * @param apiLevel One of the values within &#123;@link Build.VERSION_CODES&#125;.</span><br><span class="line">     * @return &lt;code&gt;true&lt;/code&gt; if the calling version is at least &lt;code&gt;apiLevel&lt;/code&gt;.</span><br><span class="line">     * Else &lt;code&gt;false&lt;/code&gt; is returned.</span><br><span class="line">     */</span><br><span class="line">    public static boolean isAtLeast(int apiLevel) &#123;</span><br><span class="line">        return Build.VERSION.SDK_INT &gt;= apiLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Checks if the current api level is at lower than the provided value.</span><br><span class="line">     *</span><br><span class="line">     * @param apiLevel One of the values within &#123;@link Build.VERSION_CODES&#125;.</span><br><span class="line">     * @return &lt;code&gt;true&lt;/code&gt; if the calling version is lower than &lt;code&gt;apiLevel&lt;/code&gt;.</span><br><span class="line">     * Else &lt;code&gt;false&lt;/code&gt; is returned.</span><br><span class="line">     */</span><br><span class="line">    public static boolean isLowerThan(int apiLevel) &#123;</span><br><span class="line">        return Build.VERSION.SDK_INT &lt; apiLevel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源代码地址: <a href="https://github.com/MariShunxiang/AndroidSamples/blob/master/widget/customviewstudy/src/main/java/com/sync/customviewstudy/view/RoundOutlineProvider.java" target="_blank" rel="noopener">https://github.com/MariShunxiang/AndroidSamples/blob/master/widget/customviewstudy/src/main/java/com/sync/customviewstudy/view/RoundOutlineProvider.java</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/23/Atom-编写-markdown-上传图片/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mari">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mari's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/23/Atom-编写-markdown-上传图片/" itemprop="url">Atom 编写 markdown 上传图片</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-23T15:34:13+08:00">
                2017-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Markdown/" itemprop="url" rel="index">
                    <span itemprop="name">Markdown</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为对markdown比较感兴趣,平时的文档编写都是用markdown来完成.以前是用csdn的博客编辑器,支持图片上传,预览. 最近在公司的文档也开始用markdown来写了,就会遇到一个问题：如何上传图片？</p>
<p>最开始我不知道图床啥的,就是自己先把图片上传到 github ,然后再手动引用连接到文章中,这样的也能实现markdown的图片引用. 但是不够优雅,而且很麻烦.上传一张图片有4到5步操作.</p>
<p>然后发现了 Atom编辑器的两个插件,使用 7牛 作为图床可以实现： qq截图,然后直接在 Atom 的编辑页面 <code>ctrl+v</code> 粘贴, 弹出上传图片提示，会让你填写一个 <strong>title</strong> ，点击enter会自动构建一条markdown图片语句。这样上传图片就完成了.</p>
<p>效果如下：<br><img src="http://otiwf3ulm.bkt.clouddn.com/57ba925c75d800e6bfaeb1c3ddbf171d.png" alt="七牛云图床,一键上传图片"></p>
<p>这个就是我一键上传的图片,是不是很简单! 下面我就给大家介绍实现的方法:</p>
<h3 id="第一步-注册7牛云"><a href="#第一步-注册7牛云" class="headerlink" title="第一步, 注册7牛云"></a>第一步, 注册7牛云</h3><p>7牛云的注册,新建空间就不过多介绍了.</p>
<p>吴同学博客: <a href="http://wuxiaolong.me/2014/10/30/qiniu-photo-bed/" target="_blank" rel="noopener">使用七牛作为github博客的图床
</a></p>
<p>佚名大神博客: <a href="https://xbotao.github.io/hexo-admin-qiniu/2017/02/08/qiniu.html" target="_blank" rel="noopener">如何使用七牛</a></p>
<p>相信大家可以搞定的.</p>
<h3 id="第二步-下载-markdown-assistant-qiniu-uploader-插件"><a href="#第二步-下载-markdown-assistant-qiniu-uploader-插件" class="headerlink" title="第二步, 下载 markdown-assistant,qiniu-uploader 插件"></a>第二步, 下载 markdown-assistant,qiniu-uploader 插件</h3><p><img src="http://otiwf3ulm.bkt.clouddn.com/d9153249393eb1c106781ed1c6866207.png" alt="chajian"></p>
<p>安装好插件后还需要对它们进行设置:</p>
<p>设置markdown-assistant的时候发现，会让你填一个上传插件，而且默认已经帮你填好了qiniu-uploader，其实你也就什么都不用设置了。</p>
<p>如下图:</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/6189cfff45711be2724861ae433c548d.png" alt="markdown-assistant"></p>
<p>设置qiniu-uploader，主要设置四个参数：</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/860bd5505cf4ca4a196672eef5f10b26.png" alt="qiniu-uploader"></p>
<h3 id="qiniu-uploader-使用报错解决方法"><a href="#qiniu-uploader-使用报错解决方法" class="headerlink" title="qiniu-uploader 使用报错解决方法"></a>qiniu-uploader 使用报错解决方法</h3><p>我自己在使用 <code>qiniu-uploader</code> 时Atom提示错误,如下图:</p>
<p><img src="http://otiwf3ulm.bkt.clouddn.com/da79c8140fd97dc4248e3d616d06b3a9.png" alt="qiniu-error"></p>
<p>可能你们也会遇到这个问题,<br><a href="https://github.com/knightli/qiniu-uploader/issues/6" target="_blank" rel="noopener">解决方案地址</a></p>
<p>这里我整理了一下步骤:</p>
<ol>
<li><p>先找到 Atom 的配置文件,再找到插件的安装路径. 我的电脑是Windows系统,路径是是这样的 : <code>C:\Users\Administrator\.atom\packages\qiniu-uploader\node_modules\qiniu\qiniu</code></p>
</li>
<li><p>替换 <code>\qiniu</code> 文件夹下面的三个 .js 文件: <code>io.js</code>,<code>rpc.js</code>,<code>zone.js</code>, 然后就ok了</p>
</li>
</ol>
<p>为了方便大家更换这三个文件,我就贴出来了:</p>
<p>os.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">var conf = require(&apos;./conf&apos;);</span><br><span class="line">var util = require(&apos;./util&apos;);</span><br><span class="line">var rpc = require(&apos;./rpc&apos;);</span><br><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">var getCrc32 = require(&apos;crc32&apos;);</span><br><span class="line">var url = require(&apos;url&apos;);</span><br><span class="line">var mime = require(&apos;mime&apos;);</span><br><span class="line">var Readable = require(&apos;stream&apos;).Readable;</span><br><span class="line">var formstream = require(&apos;formstream&apos;);</span><br><span class="line">var urllib = require(&apos;urllib&apos;);</span><br><span class="line">var zone = require(&apos;./zone&apos;);</span><br><span class="line"></span><br><span class="line">exports.UNDEFINED_KEY = &apos;?&apos;</span><br><span class="line">exports.PutExtra = PutExtra;</span><br><span class="line">exports.PutRet = PutRet;</span><br><span class="line">exports.put = put;</span><br><span class="line">exports.putWithoutKey = putWithoutKey;</span><br><span class="line">exports.putFile = putFile;</span><br><span class="line">exports.putReadable = putReadable;</span><br><span class="line">exports.putFileWithoutKey = putFileWithoutKey;</span><br><span class="line"></span><br><span class="line">// @gist PutExtra</span><br><span class="line">function PutExtra(params, mimeType, crc32, checkCrc) &#123;</span><br><span class="line">  this.params = params || &#123;&#125;;</span><br><span class="line">  this.mimeType = mimeType || null;</span><br><span class="line">  this.crc32 = crc32 || null;</span><br><span class="line">  this.checkCrc = checkCrc || 0;</span><br><span class="line">&#125;</span><br><span class="line">// @endgist</span><br><span class="line"></span><br><span class="line">function PutRet(hash, key) &#123;</span><br><span class="line">  this.hash = hash || null;</span><br><span class="line">  this.key = key || null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// onret: callback function instead of ret</span><br><span class="line">function putReadable (uptoken, key, rs, extra, onret) &#123;</span><br><span class="line">  if (!extra) &#123;</span><br><span class="line">    extra = new PutExtra();</span><br><span class="line">  &#125;</span><br><span class="line">  if (!extra.mimeType) &#123;</span><br><span class="line">    extra.mimeType = &apos;application/octet-stream&apos;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!key) &#123;</span><br><span class="line">    key = exports.UNDEFINED_KEY;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rs.on(&quot;error&quot;, function (err) &#123;</span><br><span class="line">      onret(&#123;code: -1, error: err.toString()&#125;, &#123;&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // 设置上传域名</span><br><span class="line">  // zone.up_host(uptoken, conf);</span><br><span class="line">  zone.up_host_async(uptoken, conf, function() &#123;</span><br><span class="line">      var form = getMultipart(uptoken, key, rs, extra);</span><br><span class="line">      return rpc.postMultipart(conf.UP_HOST, form, onret);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function put(uptoken, key, body, extra, onret) &#123;</span><br><span class="line">  var rs = new Readable();</span><br><span class="line">  rs.push(body);</span><br><span class="line">  rs.push(null);</span><br><span class="line"></span><br><span class="line">  if (!extra) &#123;</span><br><span class="line">    extra = new PutExtra();</span><br><span class="line">  &#125;</span><br><span class="line">  if (extra.checkCrc == 1) &#123;</span><br><span class="line">    var bodyCrc32 = getCrc32(body);</span><br><span class="line">    extra.crc32 = &apos;&apos; + parseInt(bodyCrc32, 16);</span><br><span class="line">  &#125; else if (extra.checkCrc == 2 &amp;&amp; extra.crc32) &#123;</span><br><span class="line">    extra.crc32 = &apos;&apos; + extra.crc32</span><br><span class="line">  &#125;</span><br><span class="line">  return putReadable(uptoken, key, rs, extra, onret)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function putWithoutKey(uptoken, body, extra, onret) &#123;</span><br><span class="line">  return put(uptoken, null, body, extra, onret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getMultipart(uptoken, key, rs, extra) &#123;</span><br><span class="line"></span><br><span class="line">  var form = formstream();</span><br><span class="line"></span><br><span class="line">  form.field(&apos;token&apos;, uptoken);</span><br><span class="line">  if (key != exports.UNDEFINED_KEY) &#123;</span><br><span class="line">    form.field(&apos;key&apos;, key);</span><br><span class="line">  &#125;</span><br><span class="line">  form.stream(&apos;file&apos;, rs, key, extra.mimeType);</span><br><span class="line"></span><br><span class="line">  if (extra.crc32) &#123;</span><br><span class="line">    form.field(&apos;crc32&apos;, extra.crc32);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (var k in extra.params) &#123;</span><br><span class="line">    form.field(k, extra.params[k]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return form;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function putFile(uptoken, key, loadFile, extra, onret) &#123;</span><br><span class="line"></span><br><span class="line">  var rs = fs.createReadStream(loadFile);</span><br><span class="line"></span><br><span class="line">  if (!extra) &#123;</span><br><span class="line">    extra = new PutExtra();</span><br><span class="line">  &#125;</span><br><span class="line">  if (extra.checkCrc == 1) &#123;</span><br><span class="line">    var fileCrc32 = getCrc32(fs.readFileSync(loadFile));</span><br><span class="line">    extra.crc32 = &apos;&apos; + parseInt(fileCrc32, 16);</span><br><span class="line">  &#125; else if (extra.checkCrc == 2 &amp;&amp; extra.crc32) &#123;</span><br><span class="line">    extra.crc32 = &apos;&apos; + extra.crc32</span><br><span class="line">  &#125;</span><br><span class="line">  if (!extra.mimeType) &#123;</span><br><span class="line">    extra.mimeType = mime.lookup(loadFile);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return putReadable(uptoken, key, rs, extra, onret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function putFileWithoutKey(uptoken, loadFile, extra, onret) &#123;</span><br><span class="line">  return putFile(uptoken, null, loadFile, extra, onret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>rpc.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">var urllib = require(&apos;urllib&apos;);</span><br><span class="line">var util = require(&apos;./util&apos;);</span><br><span class="line">var conf = require(&apos;./conf&apos;);</span><br><span class="line"></span><br><span class="line">exports.postMultipart = postMultipart;</span><br><span class="line">exports.postWithForm = postWithForm;</span><br><span class="line">exports.postWithoutForm = postWithoutForm;</span><br><span class="line"></span><br><span class="line">function postMultipart(uri, form, onret) &#123;</span><br><span class="line">  return post(uri, form, form.headers(), onret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function postWithForm(uri, form, token, onret) &#123;</span><br><span class="line">  var headers = &#123;</span><br><span class="line">    &apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;</span><br><span class="line">  &#125;;</span><br><span class="line">  if (token) &#123;</span><br><span class="line">    headers[&apos;Authorization&apos;] = token;</span><br><span class="line">  &#125;</span><br><span class="line">  return post(uri, form, headers, onret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function postWithoutForm(uri, token, onret) &#123;</span><br><span class="line">  var headers = &#123;</span><br><span class="line">    &apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;,</span><br><span class="line">  &#125;;</span><br><span class="line">  if (token) &#123;</span><br><span class="line">    headers[&apos;Authorization&apos;] = token;</span><br><span class="line">  &#125;</span><br><span class="line">  return post(uri, null, headers, onret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function post(uri, form, headers, onresp) &#123;</span><br><span class="line">  headers = headers || &#123;&#125;;</span><br><span class="line">  headers[&apos;User-Agent&apos;] = headers[&apos;User-Agent&apos;] || conf.USER_AGENT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  var data = &#123;</span><br><span class="line">    headers: headers,</span><br><span class="line">    method: &apos;POST&apos;,</span><br><span class="line">    dataType: &apos;json&apos;,</span><br><span class="line">    timeout: conf.RPC_TIMEOUT,</span><br><span class="line">  &#125;;</span><br><span class="line">  if (Buffer.isBuffer(form) || typeof form === &apos;string&apos;) &#123;</span><br><span class="line">    data.content = form;</span><br><span class="line">  &#125; else if (form) &#123;</span><br><span class="line">    data.stream = form;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    data.headers[&apos;Content-Length&apos;] = 0;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  var req = urllib.request(uri, data, function(err, result, res) &#123;</span><br><span class="line">    var rerr = null;</span><br><span class="line">    if (err || Math.floor(res.statusCode/100) !== 2) &#123;</span><br><span class="line">      rerr = &#123;code: res&amp;&amp;res.statusCode||-1, error: err||result&amp;&amp;result.error||&apos;&apos;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    onresp(rerr, result, res);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  return req;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>zone.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">// var request = require(&apos;urllib-sync&apos;).request;</span><br><span class="line">var urllib = require(&apos;urllib&apos;);</span><br><span class="line">var util = require(&apos;./util&apos;);</span><br><span class="line">//conf 为全局变量</span><br><span class="line">exports.up_host = function (uptoken, conf)&#123;</span><br><span class="line"></span><br><span class="line">    var version = process.versions;</span><br><span class="line">    var num = version.node.split(&quot;.&quot;)[0];</span><br><span class="line"></span><br><span class="line">    // node 版本号低于 1.0.0, 使用默认域名上传，可以在conf中指定上传域名</span><br><span class="line">    if(num &lt; 1 )&#123;</span><br><span class="line">        conf.AUTOZONE = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!conf.AUTOZONE)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var ak = uptoken.toString().split(&quot;:&quot;)[0];</span><br><span class="line">    var tokenPolicy = uptoken.toString().split(&quot;:&quot;)[2];</span><br><span class="line">    var tokenPolicyStr = new Buffer(tokenPolicy, &apos;base64&apos;).toString();</span><br><span class="line">    var json_tokenPolicyStr = JSON.parse(tokenPolicyStr);</span><br><span class="line"></span><br><span class="line">    var scope = json_tokenPolicyStr.scope;</span><br><span class="line">    var bucket = scope.toString().split(&quot;:&quot;)[0];</span><br><span class="line"></span><br><span class="line">    // bucket 相同，上传域名仍在过期时间内</span><br><span class="line">    if((new Date().getTime() &lt; conf.EXPIRE) &amp;&amp; bucket == conf.BUCKET)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //记录bucket名</span><br><span class="line">    conf.BUCKET = bucket;</span><br><span class="line"></span><br><span class="line">    var request_url = &apos;http://uc.qbox.me/v1/query?ak=&apos;+ ak + &apos;&amp;bucket=&apos; + bucket;</span><br><span class="line"></span><br><span class="line">    var res = request(&apos;http://uc.qbox.me/v1/query?ak=&apos;+ ak + &apos;&amp;bucket=&apos; + bucket, &#123;</span><br><span class="line">      &apos;headers&apos;: &#123;</span><br><span class="line">        &apos;Content-Type&apos;: &apos;application/json&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    if(res.statusCode == 200)&#123;</span><br><span class="line"></span><br><span class="line">        var json_str = JSON.parse(res.body.toString());</span><br><span class="line"></span><br><span class="line">        //判断设置使用的协议, 默认使用http</span><br><span class="line">        if(conf.SCHEME == &apos;http&apos;)&#123;</span><br><span class="line">            conf.UP_HOST = json_str.http.up[1];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            conf.UP_HOST = json_str.https.up[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        conf.EXPIRE = 86400 + new Date().getTime();</span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        var err = new Error(&apos;Server responded with status code &apos; + res.statusCode + &apos;:\n&apos; + res.body.toString());</span><br><span class="line">        err.statusCode = res.statusCode;</span><br><span class="line">        err.headers = res.headers;</span><br><span class="line">        err.body = res.body;</span><br><span class="line">        throw err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exports.up_host_async = function (uptoken, conf, callback)&#123;</span><br><span class="line"></span><br><span class="line">    var version = process.versions;</span><br><span class="line">    var num = version.node.split(&quot;.&quot;)[0];</span><br><span class="line"></span><br><span class="line">    // node 版本号低于 1.0.0, 使用默认域名上传，可以在conf中指定上传域名</span><br><span class="line">    if(num &lt; 1 )&#123;</span><br><span class="line">        conf.AUTOZONE = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!conf.AUTOZONE)&#123;</span><br><span class="line">        callback();</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var ak = uptoken.toString().split(&quot;:&quot;)[0];</span><br><span class="line">    var tokenPolicy = uptoken.toString().split(&quot;:&quot;)[2];</span><br><span class="line">    var tokenPolicyStr = new Buffer(tokenPolicy, &apos;base64&apos;).toString();</span><br><span class="line">    var json_tokenPolicyStr = JSON.parse(tokenPolicyStr);</span><br><span class="line"></span><br><span class="line">    var scope = json_tokenPolicyStr.scope;</span><br><span class="line">    var bucket = scope.toString().split(&quot;:&quot;)[0];</span><br><span class="line"></span><br><span class="line">    // bucket 相同，上传域名仍在过期时间内</span><br><span class="line">    if((new Date().getTime() &lt; conf.EXPIRE) &amp;&amp; bucket == conf.BUCKET)&#123;</span><br><span class="line">        callback();</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //记录bucket名</span><br><span class="line">    conf.BUCKET = bucket;</span><br><span class="line">    var request_url = &apos;http://uc.qbox.me/v1/query?ak=&apos;+ ak + &apos;&amp;bucket=&apos; + bucket;</span><br><span class="line">    var data = &#123;</span><br><span class="line">      contentType: &apos;application/json&apos;,</span><br><span class="line">      method: &apos;GET&apos;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    var req = urllib.request(request_url, data, function(err, result, res) &#123;</span><br><span class="line">      // console.log(result);</span><br><span class="line">      if(res.statusCode == 200)&#123;</span><br><span class="line">          // console.log(result);</span><br><span class="line">          var json_str = JSON.parse(result.toString());</span><br><span class="line">          // console.log(json_str);</span><br><span class="line">          //判断设置使用的协议, 默认使用http</span><br><span class="line">          if(conf.SCHEME == &apos;http&apos;)&#123;</span><br><span class="line">              conf.UP_HOST = json_str.http.up[1];</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">              conf.UP_HOST = json_str.https.up[0];</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          conf.EXPIRE = 86400 + new Date().getTime();</span><br><span class="line">          callback();</span><br><span class="line">          return;</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">          var err = new Error(&apos;Server responded with status code &apos; + res.statusCode + &apos;:\n&apos; + res.body.toString());</span><br><span class="line">          err.statusCode = res.statusCode;</span><br><span class="line">          err.headers = res.headers;</span><br><span class="line">          err.body = res.body;</span><br><span class="line">          throw err;</span><br><span class="line">          callback();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Mari</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mari</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
